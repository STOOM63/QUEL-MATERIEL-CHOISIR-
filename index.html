<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>STOOM ‚Äî Assistant mat√©riel (tablette)</title>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1020;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.085);
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --muted2:rgba(255,255,255,.52);
      --brand:#3B82F6;
      --brand2:#60A5FA;
      --ok:#22C55E;
      --warn:#F59E0B;
      --bad:#EF4444;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r: 22px;
      --tap: 64px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(59,130,246,.35), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(96,165,250,.22), transparent 55%),
        radial-gradient(900px 600px at 50% 100%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{ max-width:1080px; margin:0 auto; padding:22px 18px 40px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; margin-bottom:14px;
    }

    .brand{ display:flex; align-items:center; gap:12px; min-width:0; }
    .logo{
      width:44px; height:44px; border-radius:14px; flex:0 0 auto;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.45), transparent 60%),
        linear-gradient(135deg, rgba(59,130,246,.95), rgba(96,165,250,.65));
      box-shadow: 0 10px 30px rgba(59,130,246,.22);
      border:1px solid rgba(255,255,255,.20);
    }
    .brand h1{
      font-size:18px; line-height:1.15; margin:0; letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand p{
      margin:2px 0 0; font-size:12.5px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .actions{ display:flex; gap:10px; align-items:center; flex:0 0 auto; }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted); font-size:12.5px;
    }
    .dot{ width:8px;height:8px;border-radius:50%; background:var(--ok); box-shadow:0 0 0 6px rgba(34,197,94,.12); }

    .btn{
      border:none; border-radius:16px; min-height:48px;
      padding:12px 14px; font-weight:800; letter-spacing:.2px;
      color: rgba(255,255,255,.94);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(96,165,250,.75));
      border-color: rgba(255,255,255,.20);
      box-shadow: 0 14px 40px rgba(59,130,246,.18);
    }
    .btn.ghost{ background: rgba(255,255,255,.06); }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }

    .panel{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .panelHead{
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
    }
    .panelHead .title{ margin:0; font-size:15px; letter-spacing:.2px; }
    .panelHead .sub{
      margin:6px 0 0; color:var(--muted);
      font-size:12.5px; line-height:1.35; max-width: 58ch;
    }

    .progressWrap{ padding:0 16px 14px; }
    .progress{
      height:10px; border-radius:999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(59,130,246,.95), rgba(96,165,250,.65));
      border-right:1px solid rgba(255,255,255,.24);
      transition: width .25s ease;
    }
    .stepsRow{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap;
      color:var(--muted2); font-size:12px;
    }
    .stepChip{
      padding:7px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
    }
    .stepChip.on{
      color: rgba(255,255,255,.90);
      border-color: rgba(59,130,246,.45);
      background: rgba(59,130,246,.12);
    }

    .content{ padding:14px 16px 16px; }
    .q{
      margin:0 0 10px;
      font-size:14px;
      color: rgba(255,255,255,.90);
      letter-spacing:.2px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .q small{ font-weight:700; color:var(--muted2); }

    .options{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }

    .opt{
      min-height: var(--tap);
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      display:flex; align-items:flex-start; gap:12px;
      transition: background .15s ease, border-color .15s ease, transform .08s ease;
      user-select:none;
    }
    .opt:active{ transform: translateY(1px) scale(.995); }
    .opt .icon{
      width:38px;height:38px;border-radius:14px; flex:0 0 auto;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.07);
      display:grid; place-items:center;
      font-weight:900; color: rgba(255,255,255,.86);
    }
    .opt .txt{ min-width:0; }
    .opt .txt .t{
      font-weight:900; letter-spacing:.2px;
      font-size:14px; margin:0 0 4px;
    }
    .opt .txt .d{
      margin:0;
      color: var(--muted);
      font-size: 12.5px;
      line-height:1.25;
    }

    .opt.on{
      background: rgba(59,130,246,.12);
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 10px 26px rgba(59,130,246,.12);
    }
    .opt.on .icon{
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(96,165,250,.65));
      border-color: rgba(255,255,255,.20);
    }

    .navRow{
      margin-top:14px;
      display:flex; gap:10px;
      align-items:center; justify-content:space-between;
    }

    .side{ padding:14px; }
    .summaryTitle{
      margin:0 0 10px;
      font-size:14px;
      color: rgba(255,255,255,.88);
    }
    .mini{
      display:grid; gap:10px;
      max-height: 360px;
      overflow:auto;
      padding-right:4px;
    }
    .mini::-webkit-scrollbar{ width:8px; }
    .mini::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.10); border-radius:999px; }
    .miniCard{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:12px 12px;
    }
    .miniCard .k{ color:var(--muted2); font-size:12px; margin:0 0 6px; }
    .miniCard .v{
      margin:0;
      font-weight:900;
      font-size:13.5px;
      letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .hint{
      margin-top:12px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
    }

    .result{
      margin-top:14px;
      padding:14px 14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
    }
    .badges{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; }
    .b{
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
    }
    .b.ok{ background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.35); }
    .b.warn{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.40); }
    .b.info{ background: rgba(59,130,246,.12); border-color: rgba(59,130,246,.40); }

    .sectionTitle{
      margin: 14px 0 8px;
      font-weight:900;
      font-size:12.5px;
      color: rgba(255,255,255,.86);
      letter-spacing:.25px;
      text-transform: uppercase;
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    .kpi{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      padding:12px;
    }
    .kpi .k{ margin:0 0 6px; color:var(--muted2); font-size:12px; }
    .kpi .v{ margin:0; font-weight:1000; font-size:14px; }
    .kpi .s{ margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.25; }

    .list{
      margin: 10px 0 0;
      padding:0;
      list-style:none;
      display:grid;
      gap:8px;
    }
    .li{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }
    .li .ic{
      width:26px;height:26px;border-radius:10px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      flex:0 0 auto;
      font-weight:900;
      color: rgba(255,255,255,.86);
    }
    .li .tx{
      min-width:0;
      color: rgba(255,255,255,.86);
      font-size:12.8px;
      line-height:1.25;
    }

    .tools{ display:flex; gap:10px; margin-top:12px; }
    .tools .btn{ flex:1; }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div style="min-width:0">
          <h1>STOOM ‚Äî Assistant mat√©riel</h1>
          <p>Tablette boutique ‚Ä¢ recommandations + tips + budget tabac</p>
        </div>
      </div>

      <div class="actions">
        <div class="pill"><span class="dot"></span>Pr√™t en boutique</div>
        <button class="btn ghost" id="resetBtn" type="button">R√©initialiser</button>
      </div>
    </div>

    <div class="grid">
      <!-- Main panel -->
      <section class="panel" aria-label="Parcours">
        <header class="panelHead">
          <div>
            <h2 class="title" id="panelTitle">√âtape 1 ‚Äî Profil</h2>
            <p class="sub" id="panelSub">On pose une base fiable : consommation + sensation recherch√©e.</p>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:900;font-size:12px;color:var(--muted2);">Progression</div>
            <div style="font-weight:1000;font-size:16px;" id="pct">0%</div>
          </div>
        </header>

        <div class="progressWrap">
          <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div class="bar" id="bar"></div>
          </div>
          <div class="stepsRow" id="chips">
            <span class="stepChip on">1 Profil</span>
            <span class="stepChip">2 Habitudes</span>
            <span class="stepChip">3 Usage</span>
            <span class="stepChip">4 Priorit√©</span>
            <span class="stepChip">R√©sultat</span>
          </div>
        </div>

        <div class="content" id="content"></div>
      </section>

      <!-- Side panel -->
      <aside class="panel" aria-label="R√©sum√©">
        <div class="side">
          <h3 class="summaryTitle">R√©sum√© client</h3>

          <div class="mini">
            <div class="miniCard"><p class="k">Consommation</p><p class="v" id="sCigs">‚Äî</p></div>
            <div class="miniCard"><p class="k">Sensation</p><p class="v" id="sFeel">‚Äî</p></div>
            <div class="miniCard"><p class="k">Moments cl√©s</p><p class="v" id="sHabits">‚Äî</p></div>
            <div class="miniCard"><p class="k">Style</p><p class="v" id="sStyle">‚Äî</p></div>
            <div class="miniCard"><p class="k">Niveau</p><p class="v" id="sLevel">‚Äî</p></div>
            <div class="miniCard"><p class="k">Contexte</p><p class="v" id="sContext">‚Äî</p></div>
            <div class="miniCard"><p class="k">Priorit√©</p><p class="v" id="sPriority">‚Äî</p></div>
          </div>

          <p class="hint">
            üí° Astuce vendeur : privil√©gier la stabilit√© (tirage + dosage adapt√©s) avant d‚Äôaugmenter la puissance.
          </p>

          <div class="result" id="resultBox" style="display:none;">
            <div class="badges" id="badges"></div>

            <div class="sectionTitle">Recommandations</div>
            <div class="kpis">
              <div class="kpi">
                <p class="k">Option A ‚Äî S√©curit√©</p>
                <p class="v" id="rA">‚Äî</p>
                <p class="s" id="rANote"></p>
              </div>
              <div class="kpi">
                <p class="k">Option B ‚Äî √âvolutive</p>
                <p class="v" id="rB">‚Äî</p>
                <p class="s" id="rBNote"></p>
              </div>
              <div class="kpi">
                <p class="k">Nicotine (rep√®re)</p>
                <p class="v" id="rNico">‚Äî</p>
                <p class="s" id="rNicoNote"></p>
              </div>
              <div class="kpi">
                <p class="k">Budget tabac estim√©</p>
                <p class="v" id="rBudget">‚Äî</p>
                <p class="s" id="rBudgetNote">Base : 12,50 ‚Ç¨ / paquet (20 cig.)</p>
              </div>
            </div>

            <div class="sectionTitle">Rep√®re charges fixes</div>
            <ul class="list" id="charges"></ul>

            <div class="sectionTitle">Conseils personnalis√©s</div>
            <ul class="list" id="tips"></ul>

            <div class="sectionTitle">Points de vigilance</div>
            <ul class="list" id="avoid"></ul>

            <div class="tools">
              <button class="btn ghost" id="copyBtn" type="button">Copier le r√©sum√©</button>
              <button class="btn primary" id="newBtn" type="button">Nouveau client</button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
  // ---------------- STATE ----------------
  const state = {
    step: 1,
    cigs: null,      // low, mid, high, veryhigh
    feel: null,      // cig, balanced, vapeur
    habits: [],      // coffee, aftermeal, stress, car, breaks, morning, party, tv
    style: null,     // ritual, frequent, chain, fewpuffs, variable
    level: null,     // beginner, intermediate, advanced
    context: null,   // quick, home, car, mixed
    priority: null   // simple, autonomie, discret, vapeur, hit, gout, confort
  };

  const $ = (sel) => document.querySelector(sel);

  // ---------------- LABELS ----------------
  const L = {
    cigs: {
      low: "‚Äì 10 cig/j",
      mid: "10‚Äì15 cig/j",
      high: "15‚Äì20 cig/j",
      veryhigh: "20+ cig/j"
    },
    feel: {
      cig: "Proche cigarette",
      balanced: "√âquilibr√©",
      vapeur: "Vapeur plus dense (ma√Ætris√©e)"
    },
    habits: {
      coffee: "Caf√©",
      aftermeal: "Apr√®s repas",
      stress: "Stress",
      car: "Voiture",
      breaks: "Pauses courtes",
      morning: "R√©veil",
      party: "Soir√©e",
      tv: "TV / gaming"
    },
    style: {
      ritual: "Rituel (cigarette compl√®te)",
      frequent: "Fr√©quent (petites sessions)",
      chain: "Encha√Ænement",
      fewpuffs: "Quelques bouff√©es",
      variable: "Variable selon les moments"
    },
    level: {
      beginner: "D√©butant",
      intermediate: "D√©j√† vapot√©",
      advanced: "Confirm√©"
    },
    context: {
      quick: "Pauses rapides (travail)",
      home: "Plut√¥t maison",
      car: "Beaucoup voiture",
      mixed: "Un peu partout"
    },
    priority: {
      simple: "Simple & fiable",
      autonomie: "Autonomie",
      discret: "Discret",
      vapeur: "Vapeur",
      hit: "Hit",
      gout: "Go√ªt",
      confort: "Confort / s√©r√©nit√©"
    }
  };

  // ---------------- Budget helpers ----------------
  function fmt2(n){
    return (Math.round((n + Number.EPSILON) * 100) / 100).toFixed(2);
  }

  function avgCigsPerDay(){
    if(state.cigs === "low") return 8;
    if(state.cigs === "mid") return 12.5;
    if(state.cigs === "high") return 17.5;
    if(state.cigs === "veryhigh") return 25;
    return null;
  }

  function calcBudget(){
    const cpd = avgCigsPerDay();
    if(!cpd) return null;
    const packPrice = 12.5;
    const perDay = (cpd / 20) * packPrice;
    const perMonth = perDay * 30;
    const perYear = perDay * 365;
    return { cpd, perDay, perMonth, perYear, packPrice };
  }

  function chargeEquivalence(perYear){
    // Charges fixes uniquement ‚Äî 1 rep√®re clair
    if(perYear < 1500) return "‚âà 1 √† 2 mois d‚Äô√©lectricit√©";
    if(perYear < 2500) return "‚âà 3 √† 4 mois d‚Äô√©lectricit√©";
    if(perYear < 3500) return "‚âà 1 ann√©e d‚Äô√©lectricit√©";
    if(perYear < 4500) return "‚âà 2 √† 3 mois de loyer";
    if(perYear < 6000) return "‚âà 1 ann√©e de carburant";
    return "‚âà 1 ann√©e de charges courantes (√©nergie + carburant)";
  }

  // ---------------- UI helpers ----------------
  function isOn(key, value){
    if(Array.isArray(state[key])) return state[key].includes(value);
    return state[key] === value;
  }

  function cardOption({key, value, icon, title, desc}){
    const on = isOn(key, value) ? " on" : "";
    return `
      <div class="opt${on}" role="button" tabindex="0" data-key="${key}" data-value="${value}">
        <div class="icon">${icon}</div>
        <div class="txt">
          <p class="t">${title}</p>
          <p class="d">${desc || ""}</p>
        </div>
      </div>
    `;
  }

  function mount(html){
    $("#content").innerHTML = html;

    $("#content").querySelectorAll(".opt").forEach(el => {
      const handler = () => {
        const key = el.dataset.key;
        const val = el.dataset.value;

        if(key === "habits") return toggleHabit(val);
        return pick(key, val);
      };

      el.addEventListener("click", handler);
      el.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          handler();
        }
      });
    });
  }

  function setSummary(){
    $("#sCigs").textContent = state.cigs ? L.cigs[state.cigs] : "‚Äî";
    $("#sFeel").textContent = state.feel ? L.feel[state.feel] : "‚Äî";
    $("#sHabits").textContent = state.habits.length ? state.habits.map(h => L.habits[h]).join(" ‚Ä¢ ") : "‚Äî";
    $("#sStyle").textContent = state.style ? L.style[state.style] : "‚Äî";
    $("#sLevel").textContent = state.level ? L.level[state.level] : "‚Äî";
    $("#sContext").textContent = state.context ? L.context[state.context] : "‚Äî";
    $("#sPriority").textContent = state.priority ? L.priority[state.priority] : "‚Äî";
  }

  function setProgress(){
    const totalSteps = 5;
    const pct = Math.round(((state.step-1) / (totalSteps-1)) * 100);
    $("#pct").textContent = pct + "%";
    $("#bar").style.width = pct + "%";
    document.querySelector(".progress").setAttribute("aria-valuenow", String(pct));
    const chips = [...$("#chips").children];
    chips.forEach((c, i) => c.classList.toggle("on", i <= state.step-1));
  }

  function pick(key, value){
    state[key] = value;
    render();
    autoAdvance();
  }

  function toggleHabit(value){
    const i = state.habits.indexOf(value);
    if(i >= 0) state.habits.splice(i, 1);
    else state.habits.push(value);

    // garde l'outil fluide : max 4 habitudes
    if(state.habits.length > 4) state.habits.shift();

    render();
    autoAdvance();
  }

  function stepComplete(n){
    if(n === 1) return !!(state.cigs && state.feel);
    if(n === 2) return !!(state.habits.length >= 1 && state.style);
    if(n === 3) return !!(state.level && state.context);
    if(n === 4) return !!(state.priority);
    return true;
  }

  function autoAdvance(){
    if(state.step === 1 && stepComplete(1)){ state.step = 2; render(); return; }
    if(state.step === 2 && stepComplete(2)){ state.step = 3; render(); return; }
    if(state.step === 3 && stepComplete(3)){ state.step = 4; render(); return; }
    if(state.step === 4 && stepComplete(4)){ state.step = 5; render(); return; }
  }

  function navButtons(){
    const backDisabled = state.step === 1;
    const nextDisabled =
      (state.step === 1 && !stepComplete(1)) ||
      (state.step === 2 && !stepComplete(2)) ||
      (state.step === 3 && !stepComplete(3)) ||
      (state.step === 4 && !stepComplete(4));

    const nextLabel = state.step < 5 ? "Continuer" : "Revoir";
    return `
      <div class="navRow">
        <button class="btn ghost" type="button" ${backDisabled ? "disabled" : ""} id="backBtn">Retour</button>
        <button class="btn primary" type="button" ${nextDisabled ? "disabled" : ""} id="nextBtn">${nextLabel}</button>
      </div>
    `;
  }

  function wireNav(){
    const back = $("#backBtn");
    const next = $("#nextBtn");
    if(back) back.onclick = () => { state.step = Math.max(1, state.step-1); render(); };
    if(next) next.onclick = () => {
      if(state.step < 5){ state.step += 1; render(); }
      else{ state.step = 1; render(); }
    };
  }

  // ---------------- TIPS ENGINE ----------------
  function buildTips(){
    const tips = [];
    const h = new Set(state.habits);

    // Habitudes -> tips pro, actionnables
    if(h.has("coffee")){
      tips.push("Caf√© : commencer √† vapoter 1‚Äì2 minutes avant. Objectif : anticiper l‚Äôenvie et stabiliser la sensation.");
    }
    if(h.has("aftermeal")){
      tips.push("Apr√®s repas : rester sur une vape confortable 2‚Äì3 minutes. Inutile de chercher la vapeur : la r√©gularit√© suffit.");
    }
    if(h.has("stress")){
      tips.push("Stress : rapprocher les bouff√©es quelques minutes. Si l‚Äôenvie persiste, ajuster la nicotine plut√¥t que la puissance.");
    }
    if(h.has("car")){
      tips.push("Voiture : privil√©gier un mat√©riel discret, tirage plut√¥t serr√© et airflow stable (usage propre et r√©gulier).");
    }
    if(h.has("breaks")){
      tips.push("Pauses courtes : efficacit√© imm√©diate = tirage serr√© + dosage confortable + autonomie s√©curisante.");
    }
    if(h.has("morning")){
      tips.push("R√©veil : √©viter le sous-dosage. Mieux vaut un dosage confortable qu‚Äôune mont√©e en puissance.");
    }
    if(h.has("party")){
      tips.push("Soir√©e : conserver des r√©glages stables et un mat√©riel simple. Objectif : continuit√© et confort.");
    }
    if(h.has("tv")){
      tips.push("TV / gaming : attention √† l‚Äôautomatisme. Boire de l‚Äôeau et garder un dosage stable √©vite la surconsommation.");
    }

    // Style -> 1 tip cibl√© max (clair)
    if(state.style === "chain"){
      tips.push("Encha√Ænement : √©viter un mat√©riel trop puissant avec un dosage √©lev√© (inconfort). Prioriser la sati√©t√©.");
    } else if(state.style === "fewpuffs"){
      tips.push("Quelques bouff√©es : choisir un mat√©riel r√©actif et simple, toujours pr√™t (usage tr√®s naturel).");
    } else if(state.style === "variable"){
      tips.push("Profil variable : privil√©gier un set-up polyvalent et stable, puis ajuster progressivement selon le ressenti.");
    }

    // Priorit√© -> micro rappel
    if(state.priority === "hit"){
      tips.push("Hit : on travaille le confort via tirage + dosage, pas en augmentant la puissance.");
    } else if(state.priority === "gout"){
      tips.push("Go√ªt : puissance mod√©r√©e et mat√©riel stable = saveurs plus propres et r√©guli√®res.");
    } else if(state.priority === "autonomie"){
      tips.push("Autonomie : s√©curiser la journ√©e √©vite la panne (et donc la frustration).");
    }

    return [...new Set(tips)].slice(0, 6);
  }

  // ---------------- RECO ENGINE ----------------
  function recommend(){
    // Option A = s√©curit√© (d√©marrage, stabilit√©)
    // Option B = √©volutive (si client veut plus de polyvalence / densit√©)
    let A = { draw:"MTL (tirage serr√©)", power:"8‚Äì18W ‚Ä¢ 0.8‚Äì1.4Œ©", note:"Stabilit√©, simplicit√©, efficacit√©." };
    let B = { draw:"MTL confortable / RDL l√©ger", power:"12‚Äì30W ‚Ä¢ 0.4‚Äì1.0Œ©", note:"Polyvalent, √©volutif, sans complexit√© inutile." };

    let nico = "3‚Äì6 mg/ml";
    let nicoNote = "Rep√®re initial : viser le confort. Si envies persistantes : ajuster la nicotine plut√¥t que la puissance.";

    const badges = [];
    const avoid = [];

    // Consommation -> nicotine + vigilance
    if(state.cigs === "low"){
      nico = "3‚Äì6 mg/ml";
      badges.push({t:"Profil l√©ger", c:"info"});
    }
    if(state.cigs === "mid"){
      nico = "6‚Äì12 mg/ml";
      badges.push({t:"Profil mod√©r√©", c:"info"});
      avoid.push("Sous-dosage initial (envies persistantes).");
    }
    if(state.cigs === "high"){
      nico = "10‚Äì12 mg/ml (ou 10 mg sels selon confort)";
      badges.push({t:"Profil soutenu", c:"warn"});
      A.draw = "MTL (serr√© / restrictif)";
      A.power = "8‚Äì16W ‚Ä¢ 1.0‚Äì1.4Œ©";
      A.note = "Priorit√© : sati√©t√© + confort.";
      avoid.push("Puissance trop √©lev√©e avec nicotine forte (inconfort).");
    }
    if(state.cigs === "veryhigh"){
      nico = "12‚Äì20 mg/ml (sels possibles)";
      badges.push({t:"Profil intense", c:"warn"});
      A.draw = "MTL tr√®s restrictif";
      A.power = "8‚Äì15W ‚Ä¢ 1.0‚Äì1.4Œ©";
      A.note = "Sati√©t√© rapide, stable, s√©curisant.";
      B.draw = "RDL l√©ger (si d√©j√† vapoteur)";
      B.power = "15‚Äì28W ‚Ä¢ 0.4‚Äì0.8Œ©";
      B.note = "Possible uniquement si dosage adapt√© et accompagnement.";
      avoid.push("D√©marrer directement en tirage tr√®s a√©rien.");
      avoid.push("Diminuer la nicotine trop rapidement.");
    }

    // Sensation souhait√©e
    if(state.feel === "cig"){
      badges.push({t:"Rep√®re cigarette", c:"ok"});
      A.draw = "MTL (tirage serr√©)";
      A.note = "Rep√®re imm√©diat : hit + tirage serr√©.";
      B.draw = "MTL confortable";
      B.note = "√âvolutif, tout en gardant la stabilit√©.";
    }
    if(state.feel === "balanced"){
      badges.push({t:"Polyvalent", c:"info"});
      B.draw = "MTL confortable / RDL l√©ger";
      B.power = "12‚Äì25W ‚Ä¢ 0.6‚Äì1.0Œ©";
      B.note = "Excellent compromis au quotidien.";
    }
    if(state.feel === "vapeur"){
      badges.push({t:"Densit√© ma√Ætris√©e", c:"info"});
      B.draw = "RDL";
      B.power = "18‚Äì35W ‚Ä¢ 0.3‚Äì0.8Œ©";
      B.note = "Plus de vapeur, tout en restant confortable.";
      avoid.push("Nicotine trop √©lev√©e sur tirage trop a√©rien.");
    }

    // Niveau
    if(state.level === "beginner"){
      badges.push({t:"D√©butant", c:"ok"});
      avoid.push("Mat√©riel complexe ou trop de r√©glages au d√©part.");
    }
    if(state.level === "advanced"){
      badges.push({t:"Confirm√©", c:"info"});
      if(state.feel === "vapeur"){
        B.power = "25‚Äì45W ‚Ä¢ 0.2‚Äì0.6Œ©";
        B.note = "Possible si le dosage est adapt√© et l‚Äôusage ma√Ætris√©.";
      }
    }

    // Contexte
    if(state.context === "quick"){
      badges.push({t:"Pauses rapides", c:"info"});
      avoid.push("Autonomie trop faible (panne en journ√©e).");
    }
    if(state.context === "car"){
      badges.push({t:"Voiture", c:"info"});
      avoid.push("Airflow trop ouvert (usage moins pratique).");
    }

    // Priorit√©
    if(state.priority === "simple"){
      badges.push({t:"Simple", c:"ok"});
      A.note = "Le plus simple et le plus fiable pour d√©marrer.";
    }
    if(state.priority === "autonomie"){
      badges.push({t:"Autonomie", c:"info"});
      A.note += " Dimensionner l‚Äôautonomie pour la journ√©e.";
      B.note += " Choisir un format adapt√© √† la consommation.";
    }
    if(state.priority === "discret"){
      badges.push({t:"Discret", c:"info"});
      A.note += " Format compact recommand√©.";
      avoid.push("Format trop encombrant si besoin de discr√©tion.");
    }
    if(state.priority === "vapeur"){
      badges.push({t:"Vapeur", c:"info"});
      avoid.push("Chercher la vapeur avant la stabilit√©.");
    }
    if(state.priority === "hit"){
      badges.push({t:"Hit", c:"info"});
      avoid.push("Compenser par la puissance au lieu d‚Äôajuster le dosage.");
    }
    if(state.priority === "gout"){
      badges.push({t:"Saveurs", c:"info"});
    }
    if(state.priority === "confort"){
      badges.push({t:"Confort", c:"ok"});
      nicoNote = "Objectif : confort et r√©gularit√©. Ajuster d‚Äôabord les habitudes (rythme), puis le dosage si besoin.";
    }

    const uniqAvoid = [...new Set(avoid)];
    if(uniqAvoid.length === 0) uniqAvoid.push("Ajuster un param√®tre √† la fois : progression r√©guli√®re.");

    return { A, B, nico, nicoNote, badges, uniqAvoid };
  }

  function showResult(){
    const rec = recommend();
    const tips = buildTips();
    const bud = calcBudget();

    $("#resultBox").style.display = "block";

    // badges
    const b = rec.badges.slice(0,7).map(x => `<span class="b ${x.c}">${x.t}</span>`).join("");
    $("#badges").innerHTML = b || `<span class="b info">Recommandation</span>`;

    // recos
    $("#rA").textContent = `${rec.A.draw} ‚Ä¢ ${rec.A.power}`;
    $("#rANote").textContent = rec.A.note;

    $("#rB").textContent = `${rec.B.draw} ‚Ä¢ ${rec.B.power}`;
    $("#rBNote").textContent = rec.B.note;

    $("#rNico").textContent = rec.nico;
    $("#rNicoNote").textContent = rec.nicoNote;

    // budget + charges
    if(bud){
      $("#rBudget").textContent = `‚âà ${fmt2(bud.perMonth)} ‚Ç¨ / mois ‚Ä¢ ‚âà ${fmt2(bud.perYear)} ‚Ç¨ / an`;
      $("#rBudgetNote").textContent = `‚âà ${fmt2(bud.perDay)} ‚Ç¨ / jour (estimation sur ${bud.cpd} cig/j) ‚Ä¢ Base : 12,50 ‚Ç¨ / paquet`;

      const eq = chargeEquivalence(bud.perYear);
      $("#charges").innerHTML =
        `<li class="li"><div class="ic">‚Ç¨</div><div class="tx">√Ä titre de rep√®re : <strong>${eq}</strong>.</div></li>`;
    }else{
      $("#rBudget").textContent = "‚Äî";
      $("#rBudgetNote").textContent = "Base : 12,50 ‚Ç¨ / paquet (20 cig.)";
      $("#charges").innerHTML =
        `<li class="li"><div class="ic">‚Ç¨</div><div class="tx">S√©lectionnez la consommation pour afficher le rep√®re ‚Äúcharges fixes‚Äù.</div></li>`;
    }

    // tips
    const tipsArr = tips.length ? tips : ["Objectif : confort + r√©gularit√©. Ajuster progressivement si n√©cessaire."];
    $("#tips").innerHTML = tipsArr.map(t => `<li class="li"><div class="ic">üí°</div><div class="tx">${t}</div></li>`).join("");

    // avoid
    $("#avoid").innerHTML = rec.uniqAvoid.slice(0,5)
      .map(t => `<li class="li"><div class="ic">!</div><div class="tx">${t}</div></li>`)
      .join("");

    // copy
    $("#copyBtn").onclick = async () => {
      const budTxt = bud
        ? `Budget tabac (estim.) : ${fmt2(bud.perDay)} ‚Ç¨/jour ‚Ä¢ ${fmt2(bud.perMonth)} ‚Ç¨/mois ‚Ä¢ ${fmt2(bud.perYear)} ‚Ç¨/an (paquet 12,50‚Ç¨)`
        : `Budget tabac (estim.) : ‚Äî (paquet 12,50‚Ç¨)`;

      const eqTxt = bud ? `Rep√®re charges fixes : ${chargeEquivalence(bud.perYear)}` : `Rep√®re charges fixes : ‚Äî`;

      const txt =
`STOOM ‚Äî R√©sum√© orientation mat√©riel
- Consommation : ${state.cigs ? L.cigs[state.cigs] : "‚Äî"}
- Sensation : ${state.feel ? L.feel[state.feel] : "‚Äî"}
- Moments cl√©s : ${state.habits.length ? state.habits.map(h => L.habits[h]).join(", ") : "‚Äî"}
- Style : ${state.style ? L.style[state.style] : "‚Äî"}
- Niveau : ${state.level ? L.level[state.level] : "‚Äî"}
- Contexte : ${state.context ? L.context[state.context] : "‚Äî"}
- Priorit√© : ${state.priority ? L.priority[state.priority] : "‚Äî"}

Recommandations :
Option A (S√©curit√©) : ${rec.A.draw} ‚Ä¢ ${rec.A.power} ‚Äî ${rec.A.note}
Option B (√âvolutive) : ${rec.B.draw} ‚Ä¢ ${rec.B.power} ‚Äî ${rec.B.note}

Nicotine (rep√®re) : ${rec.nico}
Note : ${rec.nicoNote}

${budTxt}
${eqTxt}

Conseils :
- ${buildTips().slice(0,5).join("\n- ")}

Points de vigilance :
- ${rec.uniqAvoid.slice(0,3).join("\n- ")}
`;
      try{
        await navigator.clipboard.writeText(txt);
        $("#copyBtn").textContent = "Copi√© ‚úì";
        setTimeout(()=>$("#copyBtn").textContent="Copier le r√©sum√©", 1200);
      }catch(e){
        alert("Copie impossible sur cet appareil. (Astuce : utiliser Chrome)");
      }
    };

    $("#newBtn").onclick = resetAll;
  }

  // ---------------- RENDER ----------------
  function render(){
    setSummary();
    setProgress();

    const titles = {
      1: ["√âtape 1 ‚Äî Profil", "Consommation + sensation recherch√©e. Objectif : une base confortable et fiable."],
      2: ["√âtape 2 ‚Äî Habitudes", "Moments cl√©s + style de consommation. On pr√©pare des conseils personnalis√©s."],
      3: ["√âtape 3 ‚Äî Usage", "Exp√©rience + contexte. On s√©curise l‚Äôutilisation au quotidien."],
      4: ["√âtape 4 ‚Äî Priorit√©", "On finalise selon ce qui compte le plus pour le client."],
      5: ["R√©sultat ‚Äî Synth√®se STOOM", "Double recommandation + nicotine + budget tabac + rep√®re charges + conseils."]
    };
    $("#panelTitle").textContent = titles[state.step][0];
    $("#panelSub").textContent   = titles[state.step][1];

    if(state.step === 1){
      mount(`
        <div class="q">Consommation <small>obligatoire</small></div>
        <div class="options">
          ${cardOption({key:"cigs", value:"low", icon:"‚ë†", title:"‚Äì 10 / jour", desc:"Estimation budget sur ~8 cig/j."})}
          ${cardOption({key:"cigs", value:"mid", icon:"‚ë°", title:"10‚Äì15 / jour", desc:"Estimation budget sur ~12,5 cig/j."})}
          ${cardOption({key:"cigs", value:"high", icon:"‚ë¢", title:"15‚Äì20 / jour", desc:"Estimation budget sur ~17,5 cig/j."})}
          ${cardOption({key:"cigs", value:"veryhigh", icon:"‚ë£", title:"20+ / jour", desc:"Estimation budget sur ~25 cig/j."})}
        </div>

        <div style="height:14px"></div>

        <div class="q">Sensation recherch√©e <small>obligatoire</small></div>
        <div class="options">
          ${cardOption({key:"feel", value:"cig", icon:"‚üÇ", title:"Proche cigarette", desc:"Rep√®re imm√©diat : tirage serr√© + hit."})}
          ${cardOption({key:"feel", value:"balanced", icon:"‚âà", title:"√âquilibr√©", desc:"Confort + polyvalence au quotidien."})}
          ${cardOption({key:"feel", value:"vapeur", icon:"‚òÅÔ∏é", title:"Vapeur plus dense", desc:"Progressif, sans inconfort."})}
          <div style="opacity:.0;pointer-events:none"></div>
        </div>

        ${navButtons()}
      `);
      wireNav();
      $("#resultBox").style.display = "none";
    }

    if(state.step === 2){
      mount(`
        <div class="q">Moments cl√©s <small>choisir 1 √† 4</small></div>
        <div class="options">
          ${cardOption({key:"habits", value:"coffee", icon:"‚òï", title:"Caf√©", desc:"Moment typique caf√©/cigarette."})}
          ${cardOption({key:"habits", value:"aftermeal", icon:"üçΩÔ∏è", title:"Apr√®s repas", desc:"Envie marqu√©e apr√®s manger."})}
          ${cardOption({key:"habits", value:"stress", icon:"üò∞", title:"Stress", desc:"Envies li√©es au stress/tension."})}
          ${cardOption({key:"habits", value:"car", icon:"üöó", title:"Voiture", desc:"Usage fr√©quent en voiture."})}
          ${cardOption({key:"habits", value:"breaks", icon:"‚è±Ô∏è", title:"Pauses courtes", desc:"Pauses de travail."})}
          ${cardOption({key:"habits", value:"morning", icon:"üåÖ", title:"R√©veil", desc:"Premi√®re envie de la journ√©e."})}
          ${cardOption({key:"habits", value:"party", icon:"üç∫", title:"Soir√©e", desc:"Contexte soir√©e."})}
          ${cardOption({key:"habits", value:"tv", icon:"üì∫", title:"TV / gaming", desc:"Usage ‚Äúautomatique‚Äù."})}
        </div>

        <div style="height:14px"></div>

        <div class="q">Style de consommation <small>obligatoire</small></div>
        <div class="options">
          ${cardOption({key:"style", value:"ritual", icon:"üö¨", title:"Rituel (cigarette compl√®te)", desc:"‚ÄúJe la fais en entier.‚Äù"})}
          ${cardOption({key:"style", value:"frequent", icon:"‚è≥", title:"Fr√©quent (petites sessions)", desc:"‚ÄúSouvent, mais pas longtemps.‚Äù"})}
          ${cardOption({key:"style", value:"chain", icon:"üîÅ", title:"Encha√Ænement", desc:"‚ÄúPlusieurs d‚Äôaffil√©e.‚Äù"})}
          ${cardOption({key:"style", value:"fewpuffs", icon:"üëÑ", title:"Quelques bouff√©es", desc:"‚Äú2‚Äì3 bouff√©es puis pause.‚Äù"})}
          ${cardOption({key:"style", value:"variable", icon:"‚âà", title:"Variable selon les moments", desc:"‚Äú√áa d√©pend des journ√©es.‚Äù"})}
          <div style="opacity:.0;pointer-events:none"></div>
        </div>

        ${navButtons()}
      `);
      wireNav();
      $("#resultBox").style.display = "none";
    }

    if(state.step === 3){
      mount(`
        <div class="q">Niveau d‚Äôexp√©rience <small>obligatoire</small></div>
        <div class="options">
          ${cardOption({key:"level", value:"beginner", icon:"‚òÖ", title:"D√©butant", desc:"On privil√©gie simple & stable."})}
          ${cardOption({key:"level", value:"intermediate", icon:"‚òÜ", title:"D√©j√† vapot√©", desc:"On optimise confort/usage."})}
          ${cardOption({key:"level", value:"advanced", icon:"‚ú¶", title:"Confirm√©", desc:"Affinage possible si souhait√©."})}
          <div style="opacity:.0;pointer-events:none"></div>
        </div>

        <div style="height:14px"></div>

        <div class="q">Contexte principal <small>obligatoire</small></div>
        <div class="options">
          ${cardOption({key:"context", value:"quick", icon:"‚ö°", title:"Pauses rapides", desc:"Efficacit√© imm√©diate."})}
          ${cardOption({key:"context", value:"home", icon:"‚åÇ", title:"Maison", desc:"Confort + autonomie tranquille."})}
          ${cardOption({key:"context", value:"car", icon:"‚üü", title:"Voiture", desc:"Discr√©tion + stabilit√©."})}
          ${cardOption({key:"context", value:"mixed", icon:"‚ü≤", title:"Partout", desc:"Polyvalence avant tout."})}
        </div>

        ${navButtons()}
      `);
      wireNav();
      $("#resultBox").style.display = "none";
    }

    if(state.step === 4){
      mount(`
        <div class="q">Priorit√© n¬∞1 <small>obligatoire</small></div>
        <div class="options">
          ${cardOption({key:"priority", value:"simple", icon:"‚úì", title:"Simple & fiable", desc:"Prise en main imm√©diate."})}
          ${cardOption({key:"priority", value:"autonomie", icon:"üîã", title:"Autonomie", desc:"Tenir la journ√©e."})}
          ${cardOption({key:"priority", value:"discret", icon:"‚óªÔ∏é", title:"Discret", desc:"Compact et pratique."})}
          ${cardOption({key:"priority", value:"vapeur", icon:"‚òÅ", title:"Vapeur", desc:"Densit√© ma√Ætris√©e."})}
          ${cardOption({key:"priority", value:"hit", icon:"‚ö°", title:"Hit", desc:"Sensation en gorge."})}
          ${cardOption({key:"priority", value:"gout", icon:"üëÉ", title:"Go√ªt", desc:"Saveurs nettes et r√©guli√®res."})}
          ${cardOption({key:"priority", value:"confort", icon:"üòå", title:"Confort / s√©r√©nit√©", desc:"Stabilit√© et r√©gularit√©."})}
          <div style="opacity:.0;pointer-events:none"></div>
        </div>

        ${navButtons()}
      `);
      wireNav();
      $("#resultBox").style.display = "none";
    }

    if(state.step === 5){
      mount(`
        <div class="q">Synth√®se pr√™te <small>copiable</small></div>
        <div style="color:var(--muted);font-size:13px;line-height:1.45">
          Le panneau de droite affiche la recommandation STOOM, le budget tabac et les conseils personnalis√©s.  
          Vous pouvez <strong>copier le r√©sum√©</strong> pour un suivi ou un message au client.
        </div>
        ${navButtons()}
      `);
      wireNav();
      showResult();
    }

    // disabled style
    document.querySelectorAll("button[disabled]").forEach(b=>{
      b.style.opacity = .55;
      b.style.cursor = "not-allowed";
    });
  }

  function resetAll(){
    state.step = 1;
    state.cigs = null;
    state.feel = null;
    state.habits = [];
    state.style = null;
    state.level = null;
    state.context = null;
    state.priority = null;
    $("#resultBox").style.display = "none";
    render();
  }

  $("#resetBtn").onclick = resetAll;

  // init
  render();
</script>
</body>
</html>
