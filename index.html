<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>STOOM ‚Äî Hub outils (tablette)</title>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1020;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.085);
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --muted2:rgba(255,255,255,.52);
      --brand:#3B82F6;
      --brand2:#60A5FA;
      --ok:#22C55E;
      --warn:#F59E0B;
      --bad:#EF4444;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r: 22px;
      --tap: 64px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(59,130,246,.35), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(96,165,250,.22), transparent 55%),
        radial-gradient(900px 600px at 50% 100%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{ max-width:1080px; margin:0 auto; padding:22px 18px 40px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; margin-bottom:14px;
    }

    .brand{ display:flex; align-items:center; gap:12px; min-width:0; }
    .logo{
      width:44px; height:44px; border-radius:14px; flex:0 0 auto;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.45), transparent 60%),
        linear-gradient(135deg, rgba(59,130,246,.95), rgba(96,165,250,.65));
      box-shadow: 0 10px 30px rgba(59,130,246,.22);
      border:1px solid rgba(255,255,255,.20);
    }
    .brand h1{
      font-size:18px; line-height:1.15; margin:0; letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand p{
      margin:2px 0 0; font-size:12.5px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .actions{ display:flex; gap:10px; align-items:center; flex:0 0 auto; }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted); font-size:12.5px;
    }
    .dot{ width:8px;height:8px;border-radius:50%; background:var(--ok); box-shadow:0 0 0 6px rgba(34,197,94,.12); }

    .btn{
      border:none; border-radius:16px; min-height:48px;
      padding:12px 14px; font-weight:800; letter-spacing:.2px;
      color: rgba(255,255,255,.94);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(96,165,250,.75));
      border-color: rgba(255,255,255,.20);
      box-shadow: 0 14px 40px rgba(59,130,246,.18);
    }
    .btn.ghost{ background: rgba(255,255,255,.06); }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }

    .panel{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .panelHead{
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
    }
    .panelHead .title{ margin:0; font-size:15px; letter-spacing:.2px; }
    .panelHead .sub{
      margin:6px 0 0; color:var(--muted);
      font-size:12.5px; line-height:1.35; max-width: 58ch;
    }

    /* HOME GRID */
    .homeGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
      padding: 14px 16px 16px;
    }
    .tile{
      min-height: 110px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding: 14px;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, transform .08s ease;
      display:flex;
      align-items:flex-start;
      gap:12px;
      user-select:none;
    }
    .tile:active{ transform: translateY(1px) scale(.995); }
    .tile:hover{ border-color: rgba(59,130,246,.35); }
    .tile .ico{
      width:44px;height:44px;border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.07);
      display:grid;place-items:center;
      font-weight:1000;
      flex:0 0 auto;
    }
    .tile .t{ margin:0 0 6px; font-weight:1000; letter-spacing:.2px; }
    .tile .d{ margin:0; color:var(--muted); font-size:12.5px; line-height:1.25; }

    .content{ padding:14px 16px 16px; }

    /* Reuse your tool styles (options, etc.) */
    .q{
      margin:0 0 10px;
      font-size:14px;
      color: rgba(255,255,255,.90);
      letter-spacing:.2px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .q small{ font-weight:700; color:var(--muted2); }

    .options{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }
    .opt{
      min-height: var(--tap);
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      display:flex; align-items:flex-start; gap:12px;
      transition: background .15s ease, border-color .15s ease, transform .08s ease;
      user-select:none;
    }
    .opt:active{ transform: translateY(1px) scale(.995); }
    .opt .icon{
      width:38px;height:38px;border-radius:14px; flex:0 0 auto;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.07);
      display:grid; place-items:center;
      font-weight:900; color: rgba(255,255,255,.86);
    }
    .opt .txt{ min-width:0; }
    .opt .txt .t{ font-weight:900; letter-spacing:.2px; font-size:14px; margin:0 0 4px; }
    .opt .txt .d{ margin:0; color:var(--muted); font-size:12.5px; line-height:1.25; }

    .opt.on{
      background: rgba(59,130,246,.12);
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 10px 26px rgba(59,130,246,.12);
    }
    .opt.on .icon{
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(96,165,250,.65));
      border-color: rgba(255,255,255,.20);
    }

    .navRow{ margin-top:14px; display:flex; gap:10px; align-items:center; justify-content:space-between; }

    /* Side panel (summary/result) */
    .side{ padding:14px; }
    .summaryTitle{ margin:0 0 10px; font-size:14px; color: rgba(255,255,255,.88); }
    .mini{ display:grid; gap:10px; max-height:360px; overflow:auto; padding-right:4px; }
    .mini::-webkit-scrollbar{ width:8px; }
    .mini::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.10); border-radius:999px; }
    .miniCard{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:12px 12px;
    }
    .miniCard .k{ color:var(--muted2); font-size:12px; margin:0 0 6px; }
    .miniCard .v{ margin:0; font-weight:900; font-size:13.5px; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .hint{ margin-top:12px; color:var(--muted); font-size:12.5px; line-height:1.35; }

    .result{
      margin-top:14px;
      padding:14px 14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
    }

    .badges{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; }
    .b{
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
    }
    .b.ok{ background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.35); }
    .b.warn{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.40); }
    .b.info{ background: rgba(59,130,246,.12); border-color: rgba(59,130,246,.40); }

    .sectionTitle{
      margin: 14px 0 8px;
      font-weight:900;
      font-size:12.5px;
      color: rgba(255,255,255,.86);
      letter-spacing:.25px;
      text-transform: uppercase;
    }

    .kpis{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:10px; }
    .kpi{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      padding:12px;
    }
    .kpi .k{ margin:0 0 6px; color:var(--muted2); font-size:12px; }
    .kpi .v{ margin:0; font-weight:1000; font-size:14px; }
    .kpi .s{ margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.25; }

    .list{ margin:10px 0 0; padding:0; list-style:none; display:grid; gap:8px; }
    .li{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }
    .li .ic{
      width:26px;height:26px;border-radius:10px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      flex:0 0 auto;
      font-weight:900;
      color: rgba(255,255,255,.86);
    }
    .li .tx{ min-width:0; color: rgba(255,255,255,.86); font-size:12.8px; line-height:1.25; }

    .tools{ display:flex; gap:10px; margin-top:12px; }
    .tools .btn{ flex:1; }

    /* Pages */
    .page{ display:none; }
    .page.on{ display:block; }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: 1fr; }
      .homeGrid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div style="min-width:0">
          <h1>STOOM ‚Äî Hub outils</h1>
          <p>Tablette boutique ‚Ä¢ acc√®s rapide aux outils vendeurs</p>
        </div>
      </div>

      <div class="actions">
        <div class="pill"><span class="dot"></span>Pr√™t en boutique</div>
        <button class="btn ghost" id="homeBtn" type="button">Accueil</button>
        <button class="btn ghost" id="resetBtn" type="button" style="display:none;">R√©initialiser</button>
      </div>
    </div>

    <div class="grid">
      <!-- Main -->
      <section class="panel" aria-label="Zone principale">
        <header class="panelHead">
          <div>
            <h2 class="title" id="panelTitle">Accueil</h2>
            <p class="sub" id="panelSub">Choisissez un outil. Interface pens√©e pour un usage en boutique.</p>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:900;font-size:12px;color:var(--muted2);">Mode</div>
            <div style="font-weight:1000;font-size:16px;" id="modeTag">Hub</div>
          </div>
        </header>

        <!-- HOME PAGE -->
        <div class="page on" id="page-home">
          <div class="homeGrid">
            <div class="tile" role="button" tabindex="0" data-go="material">
              <div class="ico">‚ö°</div>
              <div>
                <p class="t">Choisir le mat√©riel</p>
                <p class="d">Parcours vendeur + recommandations + budget tabac + conseils.</p>
              </div>
            </div>

            <div class="tile" role="button" tabindex="0" data-go="diy">
              <div class="ico">üß™</div>
              <div>
                <p class="t">Faire mon DIY</p>
                <p class="d">Acc√®s au calculateur DIY et rep√®res de pr√©paration.</p>
              </div>
            </div>

            <div class="tile" role="button" tabindex="0" data-go="quicktips">
              <div class="ico">üí°</div>
              <div>
                <p class="t">Tips sevrage / nicotine</p>
                <p class="d">Rappels simples : dosage, confort, √©viter la reprise.</p>
              </div>
            </div>

            <div class="tile" role="button" tabindex="0" data-go="about">
              <div class="ico">‚ÑπÔ∏è</div>
              <div>
                <p class="t">Mode vendeur</p>
                <p class="d">M√©mo : r√®gles STOOM, puissance/nicotine, bonnes pratiques.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- DIY PAGE -->
        <div class="page" id="page-diy">
          <div class="content">
            <div class="q">DIY <small>acc√®s rapide</small></div>
            <div style="color:var(--muted);font-size:13px;line-height:1.45">
              Acc√®s direct au calculateur DIY STOOM.
              <div style="height:12px"></div>
              <button class="btn primary" type="button" id="openDiyBtn">Ouvrir le calculateur DIY</button>
              <div style="height:10px"></div>
              <div style="font-size:12.5px;color:var(--muted2);">
                Astuce : si la tablette bloque les popups, utilisez Chrome et autorisez l‚Äôouverture de nouveaux onglets.
              </div>
            </div>
          </div>
        </div>

        <!-- QUICKTIPS PAGE -->
        <div class="page" id="page-quicktips">
          <div class="content">
            <div class="q">Tips sevrage / nicotine <small>m√©mo</small></div>
            <ul class="list">
              <li class="li"><div class="ic">‚úì</div><div class="tx"><strong>Priorit√© :</strong> √©viter la frustration (c‚Äôest le d√©clencheur n¬∞1 des reprises).</div></li>
              <li class="li"><div class="ic">‚úì</div><div class="tx"><strong>Nicotine :</strong> ajuster le dosage avant d‚Äôaugmenter la puissance.</div></li>
              <li class="li"><div class="ic">‚úì</div><div class="tx"><strong>Progressivit√© :</strong> si objectif 0 mg, proposer une baisse graduelle.</div></li>
              <li class="li"><div class="ic">!</div><div class="tx"><strong>Vigilance :</strong> puissance √©lev√©e + dosage √©lev√© = inconfort (irritations).</div></li>
              <li class="li"><div class="ic">!</div><div class="tx"><strong>Stabilit√© :</strong> un set-up simple et fiable vaut mieux qu‚Äôun set-up ‚Äúperformant‚Äù instable.</div></li>
            </ul>
          </div>
        </div>

        <!-- ABOUT / MEMO PAGE -->
        <div class="page" id="page-about">
          <div class="content">
            <div class="q">M√©mo vendeur <small>STOOM</small></div>
            <ul class="list">
              <li class="li"><div class="ic">‚ë†</div><div class="tx"><strong>Dosage √©lev√©</strong> ‚Üí mat√©riel plut√¥t <strong>peu puissant</strong> (confort).</div></li>
              <li class="li"><div class="ic">‚ë°</div><div class="tx"><strong>Dosage faible</strong> ‚Üí mat√©riel peut √™tre <strong>plus puissant</strong> (si usage ma√Ætris√©).</div></li>
              <li class="li"><div class="ic">‚ë¢</div><div class="tx"><strong>Conseil :</strong> poser les questions (habitudes, moments cl√©s, contraintes) avant de proposer.</div></li>
              <li class="li"><div class="ic">‚ë£</div><div class="tx"><strong>Objectif :</strong> confort + r√©gularit√© + continuit√© ‚Üí sevrage durable.</div></li>
            </ul>
          </div>
        </div>

        <!-- MATERIAL TOOL PAGE -->
        <div class="page" id="page-material">
          <div class="content" id="materialRoot"></div>
        </div>
      </section>

      <!-- Side -->
      <aside class="panel" aria-label="R√©sum√©">
        <div class="side">
          <h3 class="summaryTitle">R√©sum√©</h3>

          <div id="sideHubHint" style="color:var(--muted);font-size:13px;line-height:1.45">
            S√©lectionnez un outil depuis l‚Äôaccueil.<br><br>
            üí° Astuce : gardez ce hub en favori sur la tablette.
          </div>

          <!-- MATERIAL SUMMARY -->
          <div id="sideMaterial" style="display:none;">
            <div class="mini" style="margin-top:10px;">
              <div class="miniCard"><p class="k">Consommation</p><p class="v" id="sCigs">‚Äî</p></div>
              <div class="miniCard"><p class="k">Sensation</p><p class="v" id="sFeel">‚Äî</p></div>
              <div class="miniCard"><p class="k">Moments cl√©s</p><p class="v" id="sHabits">‚Äî</p></div>
              <div class="miniCard"><p class="k">Style</p><p class="v" id="sStyle">‚Äî</p></div>
              <div class="miniCard"><p class="k">Niveau</p><p class="v" id="sLevel">‚Äî</p></div>
              <div class="miniCard"><p class="k">Contexte</p><p class="v" id="sContext">‚Äî</p></div>
              <div class="miniCard"><p class="k">Priorit√©</p><p class="v" id="sPriority">‚Äî</p></div>
            </div>

            <p class="hint">üí° En boutique : stabilit√© d‚Äôabord (tirage + dosage adapt√©s), puis √©volution si besoin.</p>

            <div class="result" id="resultBox" style="display:none;">
              <div class="badges" id="badges"></div>

              <div class="sectionTitle">Recommandations</div>
              <div class="kpis">
                <div class="kpi">
                  <p class="k">Option A ‚Äî S√©curit√©</p>
                  <p class="v" id="rA">‚Äî</p>
                  <p class="s" id="rANote"></p>
                </div>
                <div class="kpi">
                  <p class="k">Option B ‚Äî √âvolutive</p>
                  <p class="v" id="rB">‚Äî</p>
                  <p class="s" id="rBNote"></p>
                </div>
                <div class="kpi">
                  <p class="k">Nicotine (rep√®re)</p>
                  <p class="v" id="rNico">‚Äî</p>
                  <p class="s" id="rNicoNote"></p>
                </div>
                <div class="kpi">
                  <p class="k">Budget tabac estim√©</p>
                  <p class="v" id="rBudget">‚Äî</p>
                  <p class="s" id="rBudgetNote">Base : 12,50 ‚Ç¨ / paquet (20 cig.)</p>
                </div>
              </div>

              <div class="sectionTitle">Rep√®re charges fixes</div>
              <ul class="list" id="charges"></ul>

              <div class="sectionTitle">Conseils personnalis√©s</div>
              <ul class="list" id="tips"></ul>

              <div class="sectionTitle">Points de vigilance</div>
              <ul class="list" id="avoid"></ul>

              <div class="tools">
                <button class="btn ghost" id="copyBtn" type="button">Copier le r√©sum√©</button>
                <button class="btn primary" id="newBtn" type="button">Nouveau client</button>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
  // ---------------- Simple Router ----------------
  const pages = ["home","material","diy","quicktips","about"];
  function showPage(name){
    pages.forEach(p => document.getElementById("page-"+p).classList.toggle("on", p===name));

    const isTool = (name === "material");
    document.getElementById("modeTag").textContent = isTool ? "Outil" : "Hub";
    document.getElementById("resetBtn").style.display = isTool ? "inline-block" : "none";

    document.getElementById("sideHubHint").style.display = isTool ? "none" : "block";
    document.getElementById("sideMaterial").style.display = isTool ? "block" : "none";

    const titles = {
      home: ["Accueil", "Choisissez un outil. Interface pens√©e pour un usage en boutique."],
      material: ["Choisir le mat√©riel", "Parcours vendeur : recommandations coh√©rentes + budget tabac + conseils."],
      diy: ["Faire mon DIY", "Acc√®s au calculateur DIY et rep√®res de pr√©paration."],
      quicktips: ["Tips sevrage / nicotine", "M√©mo rapide : dosage, confort, stabilit√©."],
      about: ["Mode vendeur", "Rappels STOOM : r√®gles simples et efficaces."]
    };
    document.getElementById("panelTitle").textContent = titles[name][0];
    document.getElementById("panelSub").textContent = titles[name][1];

    if(name !== "material"){
      const rb = document.getElementById("resultBox");
      if(rb) rb.style.display = "none";
    }
  }

  document.getElementById("homeBtn").onclick = () => showPage("home");

  // Home tiles
  document.querySelectorAll(".tile").forEach(t => {
    const go = t.dataset.go;
    const handler = () => showPage(go);
    t.addEventListener("click", handler);
    t.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); handler(); }});
  });

  // ‚úÖ DIY external link (BRANCH√â)
  const DIY_URL = "https://stoom63.github.io/CALCULATEUR-DIY-STOOM/";
  document.getElementById("openDiyBtn").onclick = () => window.open(DIY_URL, "_blank");

  // ---------------- MATERIAL TOOL (embedded) ----------------
  const state = {
    step: 1,
    cigs: null,
    feel: null,
    habits: [],
    style: null,
    level: null,
    context: null,
    priority: null
  };

  const L = {
    cigs: { low:"‚Äì 10 cig/j", mid:"10‚Äì15 cig/j", high:"15‚Äì20 cig/j", veryhigh:"20+ cig/j" },
    feel: { cig:"Proche cigarette", balanced:"√âquilibr√©", vapeur:"Vapeur plus dense (ma√Ætris√©e)" },
    habits: { coffee:"Caf√©", aftermeal:"Apr√®s repas", stress:"Stress", car:"Voiture", breaks:"Pauses courtes", morning:"R√©veil", party:"Soir√©e", tv:"TV / gaming" },
    style: { ritual:"Rituel (cigarette compl√®te)", frequent:"Fr√©quent (petites sessions)", chain:"Encha√Ænement", fewpuffs:"Quelques bouff√©es", variable:"Variable selon les moments" },
    level: { beginner:"D√©butant", intermediate:"D√©j√† vapot√©", advanced:"Confirm√©" },
    context: { quick:"Pauses rapides (travail)", home:"Plut√¥t maison", car:"Beaucoup voiture", mixed:"Un peu partout" },
    priority: { simple:"Simple & fiable", autonomie:"Autonomie", discret:"Discret", vapeur:"Vapeur", hit:"Hit", gout:"Go√ªt", confort:"Confort / s√©r√©nit√©" }
  };

  const $ = (sel) => document.querySelector(sel);
  const root = document.getElementById("materialRoot");

  function fmt2(n){ return (Math.round((n + Number.EPSILON) * 100) / 100).toFixed(2); }
  function avgCigsPerDay(){
    if(state.cigs === "low") return 8;
    if(state.cigs === "mid") return 12.5;
    if(state.cigs === "high") return 17.5;
    if(state.cigs === "veryhigh") return 25;
    return null;
  }
  function calcBudget(){
    const cpd = avgCigsPerDay();
    if(!cpd) return null;
    const packPrice = 12.5;
    const perDay = (cpd / 20) * packPrice;
    const perMonth = perDay * 30;
    const perYear = perDay * 365;
    return { cpd, perDay, perMonth, perYear };
  }
  function chargeEquivalence(perYear){
    if(perYear < 1500) return "‚âà 1 √† 2 mois d‚Äô√©lectricit√©";
    if(perYear < 2500) return "‚âà 3 √† 4 mois d‚Äô√©lectricit√©";
    if(perYear < 3500) return "‚âà 1 ann√©e d‚Äô√©lectricit√©";
    if(perYear < 4500) return "‚âà 2 √† 3 mois de loyer";
    if(perYear < 6000) return "‚âà 1 ann√©e de carburant";
    return "‚âà 1 ann√©e de charges courantes (√©nergie + carburant)";
  }

  function isOn(key, value){
    if(Array.isArray(state[key])) return state[key].includes(value);
    return state[key] === value;
  }

  function opt({key, value, icon, title, desc}){
    const on = isOn(key, value) ? " on" : "";
    return `
      <div class="opt${on}" role="button" tabindex="0" data-key="${key}" data-value="${value}">
        <div class="icon">${icon}</div>
        <div class="txt">
          <p class="t">${title}</p>
          <p class="d">${desc || ""}</p>
        </div>
      </div>
    `;
  }

  function mountTool(html){
    root.innerHTML = html;
    root.querySelectorAll(".opt").forEach(el => {
      const handler = () => {
        const key = el.dataset.key;
        const val = el.dataset.value;
        if(key === "habits") return toggleHabit(val);
        pick(key, val);
      };
      el.addEventListener("click", handler);
      el.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); handler(); }});
    });
  }

  function setSummary(){
    $("#sCigs").textContent = state.cigs ? L.cigs[state.cigs] : "‚Äî";
    $("#sFeel").textContent = state.feel ? L.feel[state.feel] : "‚Äî";
    $("#sHabits").textContent = state.habits.length ? state.habits.map(h => L.habits[h]).join(" ‚Ä¢ ") : "‚Äî";
    $("#sStyle").textContent = state.style ? L.style[state.style] : "‚Äî";
    $("#sLevel").textContent = state.level ? L.level[state.level] : "‚Äî";
    $("#sContext").textContent = state.context ? L.context[state.context] : "‚Äî";
    $("#sPriority").textContent = state.priority ? L.priority[state.priority] : "‚Äî";
  }

  function stepComplete(n){
    if(n === 1) return !!(state.cigs && state.feel);
    if(n === 2) return !!(state.habits.length >= 1 && state.style);
    if(n === 3) return !!(state.level && state.context);
    if(n === 4) return !!(state.priority);
    return true;
  }

  function autoAdvance(){
    if(state.step === 1 && stepComplete(1)){ state.step = 2; renderTool(); return; }
    if(state.step === 2 && stepComplete(2)){ state.step = 3; renderTool(); return; }
    if(state.step === 3 && stepComplete(3)){ state.step = 4; renderTool(); return; }
    if(state.step === 4 && stepComplete(4)){ state.step = 5; renderTool(); return; }
  }

  function pick(key, value){
    state[key] = value;
    renderTool();
    autoAdvance();
  }

  function toggleHabit(value){
    const i = state.habits.indexOf(value);
    if(i >= 0) state.habits.splice(i, 1);
    else state.habits.push(value);
    if(state.habits.length > 4) state.habits.shift();
    renderTool();
    autoAdvance();
  }

  function nav(){
    const backDisabled = state.step === 1;
    const nextDisabled =
      (state.step === 1 && !stepComplete(1)) ||
      (state.step === 2 && !stepComplete(2)) ||
      (state.step === 3 && !stepComplete(3)) ||
      (state.step === 4 && !stepComplete(4));

    const nextLabel = state.step < 5 ? "Continuer" : "Revoir";
    return `
      <div class="navRow">
        <button class="btn ghost" type="button" ${backDisabled ? "disabled" : ""} id="backBtn">Retour</button>
        <button class="btn primary" type="button" ${nextDisabled ? "disabled" : ""} id="nextBtn">${nextLabel}</button>
      </div>
    `;
  }

  function wireNav(){
    const back = $("#backBtn");
    const next = $("#nextBtn");
    if(back) back.onclick = () => { state.step = Math.max(1, state.step-1); renderTool(); };
    if(next) next.onclick = () => {
      if(state.step < 5){ state.step += 1; renderTool(); }
      else{ state.step = 1; renderTool(); }
    };
  }

  function buildTips(){
    const tips = [];
    const h = new Set(state.habits);

    if(h.has("coffee")) tips.push("Caf√© : vapoter 1‚Äì2 minutes avant. Objectif : anticiper l‚Äôenvie et stabiliser la sensation.");
    if(h.has("aftermeal")) tips.push("Apr√®s repas : rester sur une vape confortable 2‚Äì3 minutes. La r√©gularit√© suffit.");
    if(h.has("stress")) tips.push("Stress : rapprocher les bouff√©es. Si besoin, ajuster la nicotine plut√¥t que la puissance.");
    if(h.has("car")) tips.push("Voiture : privil√©gier un mat√©riel discret, tirage plut√¥t serr√© et airflow stable.");
    if(h.has("breaks")) tips.push("Pauses courtes : tirage serr√© + dosage confortable + autonomie s√©curisante.");
    if(h.has("morning")) tips.push("R√©veil : √©viter le sous-dosage. Mieux vaut un dosage confortable qu‚Äôune mont√©e en puissance.");
    if(h.has("party")) tips.push("Soir√©e : conserver des r√©glages stables et un mat√©riel simple.");
    if(h.has("tv")) tips.push("TV / gaming : attention √† l‚Äôautomatisme. Hydratation + dosage stable aident beaucoup.");

    if(state.style === "chain") tips.push("Encha√Ænement : √©viter puissance √©lev√©e + dosage √©lev√© (inconfort). Prioriser la sati√©t√©.");
    if(state.style === "fewpuffs") tips.push("Quelques bouff√©es : privil√©gier un mat√©riel r√©actif et simple, toujours pr√™t.");
    if(state.style === "variable") tips.push("Profil variable : privil√©gier un set-up polyvalent et stable, puis ajuster progressivement.");

    if(state.priority === "hit") tips.push("Hit : travailler via tirage + dosage, pas en augmentant la puissance.");
    if(state.priority === "gout") tips.push("Go√ªt : puissance mod√©r√©e et mat√©riel stable = saveurs plus r√©guli√®res.");
    if(state.priority === "autonomie") tips.push("Autonomie : s√©curiser la journ√©e √©vite la panne (et la frustration).");

    return [...new Set(tips)].slice(0,6);
  }

  function recommend(){
    let A = { draw:"MTL (tirage serr√©)", power:"8‚Äì18W ‚Ä¢ 0.8‚Äì1.4Œ©", note:"Stabilit√©, simplicit√©, efficacit√©." };
    let B = { draw:"MTL confortable / RDL l√©ger", power:"12‚Äì30W ‚Ä¢ 0.4‚Äì1.0Œ©", note:"Polyvalent, √©volutif, sans complexit√© inutile." };

    let nico = "3‚Äì6 mg/ml";
    let nicoNote = "Rep√®re initial : viser le confort. Si envies persistantes : ajuster la nicotine plut√¥t que la puissance.";

    const badges = [];
    const avoid = [];

    if(state.cigs === "mid"){ nico = "6‚Äì12 mg/ml"; badges.push({t:"Profil mod√©r√©", c:"info"}); avoid.push("Sous-dosage initial (envies persistantes)."); }
    if(state.cigs === "high"){
      nico = "10‚Äì12 mg/ml (ou 10 mg sels selon confort)";
      badges.push({t:"Profil soutenu", c:"warn"});
      A.draw="MTL (serr√© / restrictif)"; A.power="8‚Äì16W ‚Ä¢ 1.0‚Äì1.4Œ©"; A.note="Priorit√© : sati√©t√© + confort.";
      avoid.push("Puissance trop √©lev√©e avec nicotine forte (inconfort).");
    }
    if(state.cigs === "veryhigh"){
      nico = "12‚Äì20 mg/ml (sels possibles)";
      badges.push({t:"Profil intense", c:"warn"});
      A.draw="MTL tr√®s restrictif"; A.power="8‚Äì15W ‚Ä¢ 1.0‚Äì1.4Œ©"; A.note="Sati√©t√© rapide, stable, s√©curisant.";
      B.draw="RDL l√©ger (si d√©j√† vapoteur)"; B.power="15‚Äì28W ‚Ä¢ 0.4‚Äì0.8Œ©"; B.note="Possible si dosage adapt√© et usage ma√Ætris√©.";
      avoid.push("D√©marrer directement en tirage tr√®s a√©rien.");
      avoid.push("Diminuer la nicotine trop rapidement.");
    }
    if(state.cigs === "low"){ badges.push({t:"Profil l√©ger", c:"info"}); }
    if(state.feel === "cig"){ badges.push({t:"Rep√®re cigarette", c:"ok"}); }
    if(state.feel === "vapeur"){ badges.push({t:"Densit√© ma√Ætris√©e", c:"info"}); avoid.push("Nicotine trop √©lev√©e sur tirage trop a√©rien."); }
    if(state.level === "beginner"){ badges.push({t:"D√©butant", c:"ok"}); avoid.push("Mat√©riel complexe au d√©part."); }
    if(state.context === "quick"){ badges.push({t:"Pauses rapides", c:"info"}); avoid.push("Autonomie trop faible (panne en journ√©e)."); }
    if(state.context === "car"){ badges.push({t:"Voiture", c:"info"}); avoid.push("Airflow trop ouvert (usage moins pratique)."); }

    if(state.priority === "simple"){ badges.push({t:"Simple", c:"ok"}); A.note="Le plus simple et le plus fiable pour d√©marrer."; }
    if(state.priority === "discret"){ badges.push({t:"Discret", c:"info"}); avoid.push("Format trop encombrant si besoin de discr√©tion."); }
    if(state.priority === "vapeur"){ badges.push({t:"Vapeur", c:"info"}); avoid.push("Chercher la vapeur avant la stabilit√©."); }
    if(state.priority === "hit"){ badges.push({t:"Hit", c:"info"}); avoid.push("Compenser par la puissance au lieu d‚Äôajuster le dosage."); }

    const uniqAvoid = [...new Set(avoid)];
    if(uniqAvoid.length === 0) uniqAvoid.push("Ajuster un param√®tre √† la fois : progression r√©guli√®re.");

    return {A,B,nico,nicoNote,badges,uniqAvoid};
  }

  function showResult(){
    const rec = recommend();
    const tips = buildTips();
    const bud = calcBudget();

    $("#resultBox").style.display = "block";
    $("#badges").innerHTML =
      rec.badges.slice(0,7).map(x => `<span class="b ${x.c}">${x.t}</span>`).join("") ||
      `<span class="b info">Recommandation</span>`;

    $("#rA").textContent = `${rec.A.draw} ‚Ä¢ ${rec.A.power}`; $("#rANote").textContent = rec.A.note;
    $("#rB").textContent = `${rec.B.draw} ‚Ä¢ ${rec.B.power}`; $("#rBNote").textContent = rec.B.note;
    $("#rNico").textContent = rec.nico; $("#rNicoNote").textContent = rec.nicoNote;

    if(bud){
      $("#rBudget").textContent = `‚âà ${fmt2(bud.perMonth)} ‚Ç¨ / mois ‚Ä¢ ‚âà ${fmt2(bud.perYear)} ‚Ç¨ / an`;
      $("#rBudgetNote").textContent = `‚âà ${fmt2(bud.perDay)} ‚Ç¨ / jour (estimation sur ${bud.cpd} cig/j) ‚Ä¢ Base : 12,50 ‚Ç¨ / paquet`;
      $("#charges").innerHTML = `<li class="li"><div class="ic">‚Ç¨</div><div class="tx">√Ä titre de rep√®re : <strong>${chargeEquivalence(bud.perYear)}</strong>.</div></li>`;
    }else{
      $("#rBudget").textContent = "‚Äî";
      $("#rBudgetNote").textContent = "Base : 12,50 ‚Ç¨ / paquet (20 cig.)";
      $("#charges").innerHTML = `<li class="li"><div class="ic">‚Ç¨</div><div class="tx">S√©lectionnez la consommation pour afficher le rep√®re ‚Äúcharges fixes‚Äù.</div></li>`;
    }

    const tipsArr = tips.length ? tips : ["Objectif : confort + r√©gularit√©. Ajuster progressivement si n√©cessaire."];
    $("#tips").innerHTML = tipsArr.map(t => `<li class="li"><div class="ic">üí°</div><div class="tx">${t}</div></li>`).join("");
    $("#avoid").innerHTML = rec.uniqAvoid.slice(0,5).map(t => `<li class="li"><div class="ic">!</div><div class="tx">${t}</div></li>`).join("");

    $("#copyBtn").onclick = async () => {
      const eqTxt = bud ? `Rep√®re charges fixes : ${chargeEquivalence(bud.perYear)}` : `Rep√®re charges fixes : ‚Äî`;
      const txt =
`STOOM ‚Äî R√©sum√© orientation mat√©riel
- Consommation : ${state.cigs ? L.cigs[state.cigs] : "‚Äî"}
- Sensation : ${state.feel ? L.feel[state.feel] : "‚Äî"}
- Moments cl√©s : ${state.habits.length ? state.habits.map(h => L.habits[h]).join(", ") : "‚Äî"}
- Style : ${state.style ? L.style[state.style] : "‚Äî"}
- Niveau : ${state.level ? L.level[state.level] : "‚Äî"}
- Contexte : ${state.context ? L.context[state.context] : "‚Äî"}
- Priorit√© : ${state.priority ? L.priority[state.priority] : "‚Äî"}

Option A (S√©curit√©) : ${rec.A.draw} ‚Ä¢ ${rec.A.power} ‚Äî ${rec.A.note}
Option B (√âvolutive) : ${rec.B.draw} ‚Ä¢ ${rec.B.power} ‚Äî ${rec.B.note}

Nicotine (rep√®re) : ${rec.nico}
Note : ${rec.nicoNote}

Budget tabac estim√© : ${bud ? `${fmt2(bud.perDay)} ‚Ç¨/jour ‚Ä¢ ${fmt2(bud.perMonth)} ‚Ç¨/mois ‚Ä¢ ${fmt2(bud.perYear)} ‚Ç¨/an` : "‚Äî"} (paquet 12,50‚Ç¨)
${eqTxt}

Conseils :
- ${buildTips().slice(0,5).join("\n- ")}

Points de vigilance :
- ${rec.uniqAvoid.slice(0,3).join("\n- ")}
`;
      try{
        await navigator.clipboard.writeText(txt);
        $("#copyBtn").textContent = "Copi√© ‚úì";
        setTimeout(()=>$("#copyBtn").textContent="Copier le r√©sum√©", 1200);
      }catch(e){
        alert("Copie impossible sur cet appareil. (Astuce : utiliser Chrome)");
      }
    };

    $("#newBtn").onclick = resetAll;
  }

  function renderTool(){
    setSummary();

    const header = (title, sub) => `<div class="q">${title} <small>${sub}</small></div>`;

    if(state.step === 1){
      mountTool(header("√âtape 1 ‚Äî Profil", "Consommation + sensation recherch√©e.") + `
        <div class="q">Consommation <small>obligatoire</small></div>
        <div class="options">
          ${opt({key:"cigs", value:"low", icon:"‚ë†", title:"‚Äì 10 / jour", desc:"Estimation budget sur ~8 cig/j."})}
          ${opt({key:"cigs", value:"mid", icon:"‚ë°", title:"10‚Äì15 / jour", desc:"Estimation budget sur ~12,5 cig/j."})}
          ${opt({key:"cigs", value:"high", icon:"‚ë¢", title:"15‚Äì20 / jour", desc:"Estimation budget sur ~17,5 cig/j."})}
          ${opt({key:"cigs", value:"veryhigh", icon:"‚ë£", title:"20+ / jour", desc:"Estimation budget sur ~25 cig/j."})}
        </div>

        <div style="height:14px"></div>

        <div class="q">Sensation recherch√©e <small>obligatoire</small></div>
        <div class="options">
          ${opt({key:"feel", value:"cig", icon:"‚üÇ", title:"Proche cigarette", desc:"Rep√®re imm√©diat : tirage serr√© + hit."})}
          ${opt({key:"feel", value:"balanced", icon:"‚âà", title:"√âquilibr√©", desc:"Confort + polyvalence."})}
          ${opt({key:"feel", value:"vapeur", icon:"‚òÅÔ∏é", title:"Vapeur plus dense", desc:"Progressif, sans inconfort."})}
          <div style="opacity:.0;pointer-events:none"></div>
        </div>

        ${nav()}
      `);
    }

    if(state.step === 2){
      mountTool(header("√âtape 2 ‚Äî Habitudes", "Moments cl√©s + style de consommation.") + `
        <div class="q">Moments cl√©s <small>choisir 1 √† 4</small></div>
        <div class="options">
          ${opt({key:"habits", value:"coffee", icon:"‚òï", title:"Caf√©", desc:"Moment typique caf√©/cigarette."})}
          ${opt({key:"habits", value:"aftermeal", icon:"üçΩÔ∏è", title:"Apr√®s repas", desc:"Envie marqu√©e apr√®s manger."})}
          ${opt({key:"habits", value:"stress", icon:"üò∞", title:"Stress", desc:"Envies li√©es au stress."})}
          ${opt({key:"habits", value:"car", icon:"üöó", title:"Voiture", desc:"Usage fr√©quent en voiture."})}
          ${opt({key:"habits", value:"breaks", icon:"‚è±Ô∏è", title:"Pauses courtes", desc:"Pauses de travail."})}
          ${opt({key:"habits", value:"morning", icon:"üåÖ", title:"R√©veil", desc:"Premi√®re envie de la journ√©e."})}
          ${opt({key:"habits", value:"party", icon:"üç∫", title:"Soir√©e", desc:"Contexte soir√©e."})}
          ${opt({key:"habits", value:"tv", icon:"üì∫", title:"TV / gaming", desc:"Usage automatique."})}
        </div>

        <div style="height:14px"></div>

        <div class="q">Style de consommation <small>obligatoire</small></div>
        <div class="options">
          ${opt({key:"style", value:"ritual", icon:"üö¨", title:"Rituel (cigarette compl√®te)", desc:"‚ÄúJe la fais en entier.‚Äù"})}
          ${opt({key:"style", value:"frequent", icon:"‚è≥", title:"Fr√©quent (petites sessions)", desc:"‚ÄúSouvent, mais pas longtemps.‚Äù"})}
          ${opt({key:"style", value:"chain", icon:"üîÅ", title:"Encha√Ænement", desc:"‚ÄúPlusieurs d‚Äôaffil√©e.‚Äù"})}
          ${opt({key:"style", value:"fewpuffs", icon:"üëÑ", title:"Quelques bouff√©es", desc:"‚Äú2‚Äì3 bouff√©es puis pause.‚Äù"})}
          ${opt({key:"style", value:"variable", icon:"‚âà", title:"Variable selon les moments", desc:"‚Äú√áa d√©pend des journ√©es.‚Äù"})}
          <div style="opacity:.0;pointer-events:none"></div>
        </div>

        ${nav()}
      `);
    }

    if(state.step === 3){
      mountTool(header("√âtape 3 ‚Äî Usage", "Exp√©rience + contexte.") + `
        <div class="q">Niveau d‚Äôexp√©rience <small>obligatoire</small></div>
        <div class="options">
          ${opt({key:"level", value:"beginner", icon:"‚òÖ", title:"D√©butant", desc:"On privil√©gie simple & stable."})}
          ${opt({key:"level", value:"intermediate", icon:"‚òÜ", title:"D√©j√† vapot√©", desc:"On optimise confort/usage."})}
          ${opt({key:"level", value:"advanced", icon:"‚ú¶", title:"Confirm√©", desc:"Affinage possible."})}
          <div style="opacity:.0;pointer-events:none"></div>
        </div>

        <div style="height:14px"></div>

        <div class="q">Contexte principal <small>obligatoire</small></div>
        <div class="options">
          ${opt({key:"context", value:"quick", icon:"‚ö°", title:"Pauses rapides", desc:"Efficacit√© imm√©diate."})}
          ${opt({key:"context", value:"home", icon:"‚åÇ", title:"Maison", desc:"Confort + autonomie."})}
          ${opt({key:"context", value:"car", icon:"‚üü", title:"Voiture", desc:"Discr√©tion + stabilit√©."})}
          ${opt({key:"context", value:"mixed", icon:"‚ü≤", title:"Partout", desc:"Polyvalence."})}
        </div>

        ${nav()}
      `);
    }

    if(state.step === 4){
      mountTool(header("√âtape 4 ‚Äî Priorit√©", "Ce qui compte le plus pour le client.") + `
        <div class="q">Priorit√© n¬∞1 <small>obligatoire</small></div>
        <div class="options">
          ${opt({key:"priority", value:"simple", icon:"‚úì", title:"Simple & fiable", desc:"Prise en main imm√©diate."})}
          ${opt({key:"priority", value:"autonomie", icon:"üîã", title:"Autonomie", desc:"Tenir la journ√©e."})}
          ${opt({key:"priority", value:"discret", icon:"‚óªÔ∏é", title:"Discret", desc:"Compact et pratique."})}
          ${opt({key:"priority", value:"vapeur", icon:"‚òÅ", title:"Vapeur", desc:"Densit√© ma√Ætris√©e."})}
          ${opt({key:"priority", value:"hit", icon:"‚ö°", title:"Hit", desc:"Sensation en gorge."})}
          ${opt({key:"priority", value:"gout", icon:"üëÉ", title:"Go√ªt", desc:"Saveurs r√©guli√®res."})}
          ${opt({key:"priority", value:"confort", icon:"üòå", title:"Confort / s√©r√©nit√©", desc:"Stabilit√© et r√©gularit√©."})}
          <div style="opacity:.0;pointer-events:none"></div>
        </div>

        ${nav()}
      `);
    }

    if(state.step === 5){
      mountTool(header("R√©sultat ‚Äî Synth√®se", "R√©sum√© complet pr√™t √† copier.") + `
        <div style="color:var(--muted);font-size:13px;line-height:1.45">
          Le panneau de droite affiche la synth√®se compl√®te (recommandations, budget, rep√®re charges fixes, conseils).
        </div>
        ${nav()}
      `);
      showResult();
    }

    wireNav();

    root.querySelectorAll("button[disabled]").forEach(b=>{
      b.style.opacity = .55;
      b.style.cursor = "not-allowed";
    });
  }

  function resetAll(){
    state.step = 1;
    state.cigs = null; state.feel = null; state.habits = [];
    state.style = null; state.level = null; state.context = null; state.priority = null;
    $("#resultBox").style.display = "none";
    renderTool();
  }

  document.getElementById("resetBtn").onclick = resetAll;

  // Start on home
  showPage("home");

  // Ensure tool renders when entering material
  const _showPage = showPage;
  showPage = function(name){
    _showPage(name);
    if(name === "material") renderTool();
  };
</script>
</body>
</html>
